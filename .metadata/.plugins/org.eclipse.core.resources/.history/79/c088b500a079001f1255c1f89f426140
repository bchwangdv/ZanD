<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>THE ZD</title>
<!-- JQuery 3.7.1-->
<script src="https://code.jquery.com/jquery-3.7.1.js"></script>
</head>
<!-- navbar -->
<div th:replace="~{navbar :: navbar}"></div>
<!-- css -->
<link type="text/css" href='css/searchResult.css' rel="stylesheet">
<body>
<div class="halfline"></div>

<div class="namecard">
	<div>[[${nickname}]]</div>
</div>


<input type="hidden" id="ouidDiv"></input>

<div class="resultContatiner">
	<div id="searchResult"></div>
</div>
<script th:inline="javascript">
const API_KEY = "test_cae361c9b131e27b911a544f8f7a1b8b30a26678c7d36bb7ae8f2747f4a6fa18efe8d04e6d233bd35cf2fabdeb93fb0d";
const resultDiv = $("#searchResult");

const nickname = [[${nickname}]]
const ouidReq = "https://open.api.nexon.com/fconline/v1/id?nickname=" + nickname;
const ouidObj = fetch(ouidReq, {
    headers:{
      "x-nxopen-api-key": API_KEY
    }
})
	.then(response => response.json())
	.then(data => {
		const ouidDiv = document.getElementById("ouidDiv");
		const ouid = data.ouid
		ouidDiv.value = ouid;
		const matchReq = "https://open.api.nexon.com/fconline/v1/user/match?ouid=" + ouid + "&matchtype=50";
		
		fetch(matchReq, {
	        headers: {
	            "x-nxopen-api-key": API_KEY
	        }
	    })
	    .then(response => response.json())
	    .then(matchIds => {
	        if (matchIds.length === 0) {
	            resultDiv.append("최근 공식경기가 없습니다.");
	            return;
	        }
	        
	        const matchDetailPromises = matchIds.map(matchId => {
	            const matchDetailReq = "https://open.api.nexon.com/fconline/v1/match-detail?matchid=" + matchId;
	            return fetch(matchDetailReq, {
	                headers: {
	                    "x-nxopen-api-key": API_KEY
	                }
	            }).then(response => response.json());
	        });
	        
	        Promise.all(matchDetailPromises)
	        .then(matchDetails => {
	        	
	        	matchDetails.sort((a, b) => new Date(b.matchDate) - new Date(a.matchDate));
	        	
	            const usersOuid = $("#ouidDiv").val();

	            matchDetails.forEach(data => {
	            	
	            	const matchContainer = document.createElement("div");
	                matchContainer.className = "match-container"; // 스타일을 위한 클래스 추가

	                const dateDiv = document.createElement("div");
	                const matchTypeDiv = document.createElement("div");
	                const opResultDiv = document.createElement("div");
	                const matchResultDiv = document.createElement("div");

	                const matchDay = data.matchDate.split("T")[0];
	                const matchTime = data.matchDate.split("T")[1];
	                
	            	// 날짜 및 시간 출력
					dateDiv.innerHTML = '<strong>날짜</strong>:' + matchDay + ' ' + matchTime;
					matchContainer.appendChild(dateDiv);

	                // 매치 타입 출력
	                matchTypeDiv.innerHTML = '<strong>매치타입</strong>: 공식경기';
	                matchContainer.appendChild(matchTypeDiv);

	                // 매치 결과 출력
	                data.matchInfo.forEach(infos => {
	                    if (infos.ouid == usersOuid) {
	                    	var myInfo = infos;
	                    }
	                    
//                         matchResultDiv.innerHTML = '<strong>결과</strong>: ' + myInfo.shoot.goalTotal + ' : ' + opInfo.shoot.goalTotal + ' ' + myInfo.matchDetail.matchResult;
//                         matchContainer.appendChild(matchResultDiv);
//                         opResultDiv.innerHTML = '<strong>상대</strong>: ' + opInfo.nickname;
//                         matchContainer.appendChild(opResultDiv);
	                });
	                
	                // 결과를 검색 결과 div에 추가
	                resultDiv.append(matchContainer);
	            });
	        })
			.catch(error => console.error(error))
		})
		.catch(error => console.error(error))
	})
	.catch(error => console.error(error))
</script>
</body>
</html>